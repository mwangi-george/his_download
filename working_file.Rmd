```{r}
dx <- "rEQd6IDeXWT"
ou <- "BjC1xL40gHo"
pe <- "202109"

sample_df <- generate_url(dx, ou, pe)
```
```{r}

```



```{r}
sample_df %>% 
    transmute(
        data_element,
        period = my(period),
        organisation_unit,
        value
    )
```


```{r}
library(dhis2r)

dhis2_connection <- Dhis2r$new(
    base_url = "https://hiskenya.org/",
    username = "mikonya",
    password = "Kenya2030"
)


tryCatch(
    expr = {
        dhis2_connection$get_analytics(
        analytic = dx,
        org_unit = ou,
        period = pe,
        output_scheme = "NAME"
        )
    },
    error = function(e){
        print(e)
    }
)


library(httr)

url <- "https://hiskenya.org/api/me"
username<-"mikonya"
password<-"Kenya2030"
login<-GET(url, authenticate(username,password))
#If we cannot login, stop with an error
if(login$status == 200L) { print("Logged in successfully!")} else {stop("Could not login")}
```

```{r}
library(DBI)

my_db_connection <- dbConnect(drv = odbc::odbc(), .connection_string = "Driver={PostgreSQL ANSI(x64)};", 
    database = "FP", UID = Sys.getenv("POSTGRES_DB_NAME"), PWD = Sys.getenv("POSTGRES_DB_PASSWORD"), 
    Port = 5432, timeout = 10)

lite_conn <- sqlite_conn("metadata")

org_units <- dbGetQuery(my_db_connection, "select * from organisation_units")
dbWriteTable(lite_conn, "org_units", org_units)
data_elements <- dbGetQuery(my_db_connection, "select * from data_elements")
dbWriteTable(lite_conn, "data_elements", data_elements)
indicators <- dbGetQuery(my_db_connection, "select * from indicators")
dbWriteTable(lite_conn, "indicators", indicators)


```


```{r}
data_elements %>% 
    filter(
        name %in% c(focus_data_elements %>% pull(data_element))
    )

data_elements %>% 
    distinct(name)

```
```{r}
focus_data_elements
```


```{r}
data_elements <- function(){
    query_res <- dbGetQuery(
        lite_conn, 
        "SELECT name, id FROM data_elements WHERE name IN ('MOH 747A_DMPA-IM', 'MOH 747A_DMPA-SC');"
    ) 
    
    named_elements_vector <- set_names(query_res$id, query_res$id)
    return(named_elements_vector)
} 
    
```



```{r}
response <- dhis2_connection$get_analytics(
        analytic = dx,
        org_unit = ou,
        period = pe,
        output_scheme = "NAhME"
        )

class(response)

if (class(response) %in% c("tbl_df", "tbl", "data.frame")) {
    print("yes")
}
```


```{r}
dhis2_connection$get_metadata(endpoint = "dataElements")

extract_metadata_units <- memoise(
  function(his_username, his_password,
           base_url = "https://hiskenya.org", 
           org_units_level = 2, 
           endpoint = "organisationUnits", 
           searched_dx = NULL) {
      
    if (endpoint == "organisationUnits") {
      endpoint_url <- glue("{base_url}/api/{endpoint}?fields=name,id&filter=level:in:[{org_units_level}]&paging=false")
    } else if (endpoint == "dataElements") {
        endpoint_url <- glue("{base_url}/api/{endpoint}?fields=name,id&filter=name:like:{searched_dx}&paging=false")
    }
      
    tryCatch(
      expr = {
        response <- GET(url = endpoint_url, authenticate(his_username, his_password)) %>%
          content() %>%
          jsonlite::toJSON(auto_unbox = T) %>%
          jsonlite::fromJSON()
        response_df <- response[[1]]
        response_named_vector <- set_names(response_df$id, response_df$name)

        return(response_named_vector)
      },
      error = function(e) {
        print(e)
      }
    )
  }
)

extract_metadata_units("mikonya", "Kenya2030", endpoint = "dataElements", searched_dx = "747A") -> x

x[1]
```





















